{% extends "base.html" %}
{% block title %}Chi Ti·∫øt S√°ch (Admin): {{ sach.tieu_de }}{% endblock %}

{# ========================================================= #}
{# BLOCK CONTENT: N·ªôi dung ch√≠nh c·ªßa trang chi ti·∫øt s√°ch (Admin) #}
{# ========================================================= #}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Chi Ti·∫øt S√°ch: {{ sach.tieu_de }}</h1>
    <div>
        {# N√∫t kh√¥i ph·ª•c ch·ªâ hi·ªÉn th·ªã n·∫øu s√°ch ƒëang b·ªã ·∫©n #}
        {% if sach.trang_thai == 'da_an' %}
        <span class="badge bg-danger p-2 me-2">ƒê√É B·ªä ·∫®N</span>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmRestoreModal">
            Kh√¥i Ph·ª•c S√°ch
        </button>
        {% endif %}
        {# N√∫t s·ª≠a lu√¥n hi·ªÉn th·ªã #}
        <a href="{{ url_for('admin.sua_sach', id_sach=sach.id_sach) }}" class="btn btn-warning">‚úèÔ∏è S·ª≠a S√°ch N√†y</a>
        {# N√∫t ·∫©n ch·ªâ hi·ªÉn th·ªã n·∫øu s√°ch ƒëang ho·∫°t ƒë·ªông #}
        {% if sach.trang_thai == 'hoat_dong' %}
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
            üóëÔ∏è ·∫®n S√°ch N√†y
        </button>
        {% endif %}
    </div>
</div>

{# --- Khu v·ª±c hi·ªÉn th·ªã th√¥ng tin s√°ch v√† th·ªëng k√™ --- #}
<div class="row mb-4">
    <div class="col-md-3 text-center">
        {# ·∫¢nh b√¨a s√°ch #}
        <img src="{{ url_for('static', filename='uploads/covers/' ~ (sach.anh_bia | default('default_cover.jpg'))) }}"
            class="img-fluid rounded shadow-sm" alt="{{ sach.tieu_de }}" style="max-height: 350px; object-fit: cover;">
    </div>
    <div class="col-md-5">
        <h4>Th√¥ng Tin C∆° B·∫£n</h4>
        {# Danh s√°ch th√¥ng tin c∆° b·∫£n #}
        <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <strong>ID S√°ch:</strong>
                <span class="badge bg-secondary rounded-pill">{{ sach.id_sach }}</span>
            </li>
            <li class="list-group-item"><strong>T√°c gi·∫£:</strong> {{ sach.ten_tac_gia | default('N/A') }}</li>
            <li class="list-group-item"><strong>Th·ªÉ lo·∫°i:</strong> {{ sach.ten_the_loai | default('N/A') }}</li>
            <li class="list-group-item"><strong>NƒÉm xu·∫•t b·∫£n:</strong> {{ sach.nam_xuat_ban | default('N/A') }}</li>
            <li class="list-group-item"><strong>S·ªë trang:</strong> {{ sach.so_trang if sach.so_trang and sach.so_trang >
                0 else 'N/A' }}</li>
        </ul>
    </div>
    <div class="col-md-4">
        <h4>Th·ªëng K√™ (Admin)</h4>
        {# Danh s√°ch c√°c s·ªë li·ªáu th·ªëng k√™ d√†nh cho admin #}
        <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between align-items-center">
                S·ªë l∆∞·ª£ng trong kho (C√≥ s·∫µn) {# S·ªë l∆∞·ª£ng ghi trong b·∫£ng Sach #}
                <span class="badge bg-success rounded-pill">{{ stats.sach_trong_kho | default(0) }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                S·ªë l∆∞·ª£ng ƒëang m∆∞·ª£n (ƒê√£ l·∫•y) {# T·ªïng s·ªë l∆∞·ª£ng s√°ch ƒëang ·ªü tr·∫°ng th√°i 'ƒêang m∆∞·ª£n' #}
                <span class="badge bg-info text-dark rounded-pill">{{ stats.sach_dang_muon_sum | default(0) }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                S·ªë l∆∞·ª£ng ch·ªù duy·ªát (ƒêang gi·ªØ) {# T·ªïng s·ªë l∆∞·ª£ng s√°ch ƒëang ·ªü tr·∫°ng th√°i 'ƒêang ch·ªù' #}
                <span class="badge bg-warning text-dark rounded-pill">{{ stats.sach_cho_duyet_sum | default(0) }}</span>
                {# Hi·ªÉn th·ªã s·ªë l∆∞·ª£t ƒë·∫∑t n·∫øu kh√°c t·ªïng s·ªë l∆∞·ª£ng ch·ªù #}
                {% if stats.sach_cho_duyet_count != stats.sach_cho_duyet_sum %}
                <small class="text-muted ms-1">({{ stats.sach_cho_duyet_count | default(0) }} l∆∞·ª£t)</small>
                {% endif %}
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <strong>T·ªïng s·ªë b·∫£n sao (Th∆∞ vi·ªán c√≥)</strong> {# T·ªïng = kho + m∆∞·ª£n + ch·ªù #}
                <span class="badge bg-primary rounded-pill">{{ stats.tong_so_ban_sao | default(0) }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                T·ªïng l∆∞·ª£t m∆∞·ª£n (Th√†nh c√¥ng) {# T·ªïng s·ªë l∆∞·ª£t m∆∞·ª£n c√≥ tr·∫°ng th√°i 'ƒêang m∆∞·ª£n' ho·∫∑c 'ƒê√£ tr·∫£' #}
                <span class="badge bg-secondary rounded-pill">{{ stats.tong_luot_muon_thuc | default(0) }}</span>
            </li>
        </ul>
    </div>
</div>
<hr>

{# --- Khu v·ª±c hi·ªÉn th·ªã L·ªãch s·ª≠ M∆∞·ª£n --- #}
<div class="row mb-4">
    <div class="col-12">
        <h4>L·ªãch S·ª≠ M∆∞·ª£n (To√†n b·ªô)</h4>
        <div style="max-height: 400px; overflow-y: auto;"> {# Gi·ªõi h·∫°n chi·ªÅu cao v√† cho ph√©p cu·ªôn #}
            <table class="table table-bordered table-striped">
                <thead class="table-dark sticky-top"> {# sticky-top gi·ªØ header c·ªë ƒë·ªãnh khi cu·ªôn #}
                    <tr>
                        <th>Ng∆∞·ªùi M∆∞·ª£n</th>
                        <th>S·ªë L∆∞·ª£ng</th>
                        <th>Ng√†y M∆∞·ª£n</th>
                        <th>Ng√†y H·∫πn Tr·∫£</th>
                        <th>Ng√†y Tr·∫£ Th·ª±c</th>
                        <th>Tr·∫°ng Th√°i</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in lich_su_muon %}
                    <tr>
                        <td>{{ item.ho_ten }}</td>
                        <td>{{ item.so_luong }}</td>
                        <td>{{ item.ngay_muon.strftime('%d-%m-%Y') if item.ngay_muon else 'N/A' }}</td>
                        <td>{{ item.ngay_hen_tra.strftime('%d-%m-%Y') if item.ngay_hen_tra else 'N/A' }}</td>
                        <td>{{ item.ngay_tra_thuc.strftime('%d-%m-%Y %H:%M') if item.ngay_tra_thuc else 'Ch∆∞a tr·∫£' }}
                        </td>
                        <td>
                            {# Hi·ªÉn th·ªã badge tr·∫°ng th√°i t∆∞∆°ng ·ª©ng #}
                            {% if item.trang_thai == 'ƒê√£ tr·∫£' %} <span class="badge bg-success">ƒê√£ tr·∫£</span>
                            {% elif item.trang_thai == 'ƒê√£ h·ªßy' %} <span class="badge bg-danger">ƒê√£ h·ªßy</span>
                            {% elif item.trang_thai == 'ƒêang ch·ªù' %} <span class="badge bg-secondary">ƒêang ch·ªù</span>
                            {% elif item.ngay_hen_tra and item.ngay_hen_tra < today_date %} <span
                                class="badge bg-danger">Qu√° h·∫°n</span>
                                {% else %} <span class="badge bg-warning text-dark">ƒêang m∆∞·ª£n</span>
                                {% endif %}
                        </td>
                    </tr>
                    {% else %} {# Hi·ªÉn th·ªã n·∫øu ch∆∞a c√≥ l·ªãch s·ª≠ #}
                    <tr>
                        <td colspan="6" class="text-center">S√°ch n√†y ch∆∞a t·ª´ng ƒë∆∞·ª£c m∆∞·ª£n.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<hr>

{# --- Khu v·ª±c Qu·∫£n l√Ω B√¨nh lu·∫≠n --- #}
<div class="row">
    <div class="col-12">
        <h4>Qu·∫£n L√Ω B√¨nh Lu·∫≠n ({{ binh_luan|length }})</h4>
        <div style="max-height: 400px; overflow-y: auto;"> {# Gi·ªõi h·∫°n chi·ªÅu cao v√† cho ph√©p cu·ªôn #}
            <ul class="list-group" id="commentList"> {# ID cho JS d·ªÖ t√¨m #}
                {% for bl in binh_luan %}
                <li class="list-group-item" id="comment-{{ bl.id_binh_luan }}"> {# ID duy nh·∫•t cho m·ªói b√¨nh lu·∫≠n #}
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>{{ bl.ho_ten }}</strong> {# T√™n ng∆∞·ªùi b√¨nh lu·∫≠n #}
                            <small class="text-muted ms-2">{{ bl.ngay_dang.strftime('%d-%m-%Y %H:%M') }}</small> {# Th·ªùi
                            gian ƒëƒÉng #}
                            <p class="mb-0 mt-1">{{ bl.noi_dung }}</p> {# N·ªôi dung b√¨nh lu·∫≠n #}
                        </div>
                        {# N√∫t m·ªü modal x√°c nh·∫≠n x√≥a b√¨nh lu·∫≠n #}
                        <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal"
                            data-bs-target="#confirmDeleteCommentModal" data-comment-id="{{ bl.id_binh_luan }}"
                            data-comment-author="{{ bl.ho_ten }}">
                            X√≥a
                        </button>
                    </div>
                </li>
                {% else %} {# Hi·ªÉn th·ªã n·∫øu ch∆∞a c√≥ b√¨nh lu·∫≠n #}
                <li class="list-group-item text-center text-muted" id="noCommentsMessage">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

{# --- C√°c Modal X√°c Nh·∫≠n --- #}

{# Modal X√°c nh·∫≠n ·∫®n S√°ch #}
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">X√°c Nh·∫≠n ·∫®n S√°ch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ·∫©n s√°ch <strong>'{{ sach.tieu_de }}'</strong>? <br> S√°ch s·∫Ω kh√¥ng hi·ªÉn th·ªã v·ªõi ƒë·ªôc
                gi·∫£ nh∆∞ng v·∫´n gi·ªØ nguy√™n l·ªãch s·ª≠ m∆∞·ª£n.
            </div>
            <div class="modal-footer">
                {# Form n√†y s·∫Ω ƒë∆∞·ª£c submit b·∫±ng JavaScript (AJAX) #}
                <form id="deleteForm" method="POST" action="{{ url_for('admin.an_sach', id_sach=sach.id_sach) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-danger" id="confirmHideSubmitButton">X√°c Nh·∫≠n ·∫®n</button>
                </form>
            </div>
        </div>
    </div>
</div>

{# Modal X√°c nh·∫≠n Kh√¥i ph·ª•c S√°ch #}
<div class="modal fade" id="confirmRestoreModal" tabindex="-1" aria-labelledby="modalLabelRestore" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabelRestore">X√°c Nh·∫≠n Kh√¥i Ph·ª•c S√°ch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√¥i ph·ª•c s√°ch <strong>'{{ sach.tieu_de }}'</strong>? <br> S√°ch s·∫Ω hi·ªÉn th·ªã tr·ªü
                l·∫°i v·ªõi ƒë·ªôc gi·∫£.
            </div>
            <div class="modal-footer">
                {# Form n√†y s·∫Ω ƒë∆∞·ª£c submit b·∫±ng JavaScript (AJAX) #}
                <form id="restoreForm" method="POST"
                    action="{{ url_for('admin.khoi_phuc_sach', id_sach=sach.id_sach) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-success" id="confirmRestoreSubmitButton">X√°c Nh·∫≠n Kh√¥i
                        Ph·ª•c</button>
                </form>
            </div>
        </div>
    </div>
</div>

{# Modal X√°c nh·∫≠n X√≥a B√¨nh Lu·∫≠n #}
<div class="modal fade" id="confirmDeleteCommentModal" tabindex="-1" aria-labelledby="commentModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentModalLabel">X√°c Nh·∫≠n X√≥a B√¨nh Lu·∫≠n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n c·ªßa <strong id="modalCommentAuthor"></strong>? H√†nh ƒë·ªông n√†y kh√¥ng
                th·ªÉ ho√†n t√°c.
            </div>
            <div class="modal-footer">
                {# Form n√†y s·∫Ω ƒë∆∞·ª£c submit b·∫±ng JavaScript (AJAX), action s·∫Ω ƒë∆∞·ª£c JS c·∫≠p nh·∫≠t #}
                <form id="deleteCommentForm" method="POST" action="">
                    {# G·ª≠i ID s√°ch ƒë·ªÉ redirect l·∫°i trang chi ti·∫øt sau khi x√≥a (ph√≤ng tr∆∞·ªùng h·ª£p JS l·ªói) #}
                    <input type="hidden" name="id_sach_redirect" value="{{ sach.id_sach }}">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-danger" id="confirmDeleteCommentSubmitButton">X√°c Nh·∫≠n
                        X√≥a</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{# ========================================================= #}
{# BLOCK SCRIPTS: Ch·ª©a m√£ JavaScript cho trang #}
{# ========================================================= #}
{% block scripts %}
{{ super() }} {# Nh√∫ng c√°c script chung t·ª´ base.html #}
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // --- H√†m Helper: L·∫•y CSRF token ---
        function getCsrfToken() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            return meta ? meta.getAttribute('content') : null;
        }

        // --- H√†m Chung: X·ª≠ l√Ω Submit Modal ·∫®n/Kh√¥i Ph·ª•c S√°ch b·∫±ng AJAX ---
        // H√†m n√†y nh·∫≠n v√†o modal, form, n√∫t submit v√† th·ª±c hi·ªán fetch request
        async function handleBookStatusAction(modalElement, formElement, submitButton) {
            formElement.addEventListener('submit', async function (event) {
                event.preventDefault(); // NgƒÉn submit form m·∫∑c ƒë·ªãnh
                const actionUrl = formElement.action; // L·∫•y URL t·ª´ action c·ªßa form
                const originalButtonText = submitButton.innerHTML;
                const csrfToken = getCsrfToken(); // L·∫•y token
                const headers = { 'X-CSRFToken': csrfToken }; // Chu·∫©n b·ªã header

                // V√¥ hi·ªáu h√≥a n√∫t v√† hi·ªÉn th·ªã loading
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...`;

                try {
                    // G·ª≠i request POST b·∫±ng Fetch API
                    const response = await fetch(actionUrl, { method: 'POST', headers: headers });
                    const data = await response.json(); // ƒê·ªçc ph·∫£n h·ªìi JSON

                    if (response.ok && data.success) {
                        // N·∫øu th√†nh c√¥ng -> T·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
                        window.location.reload();
                    } else {
                        // N·∫øu l·ªói -> N√©m l·ªói ƒë·ªÉ ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü catch
                        throw new Error(data.error || `L·ªói HTTP ${response.status}`);
                    }
                } catch (error) {
                    // X·ª≠ l√Ω l·ªói (m·∫°ng ho·∫∑c logic)
                    // Gi·∫£ ƒë·ªãnh h√†m showNotification ƒë√£ c√≥ trong base.html
                    showNotification(`ƒê√£ x·∫£y ra l·ªói: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`, 'danger');
                } finally {
                    // Lu√¥n k√≠ch ho·∫°t l·∫°i n√∫t v√† ƒë√≥ng modal sau khi x·ª≠ l√Ω xong
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) modalInstance.hide();
                }
            });
        }

        // --- G·∫Øn s·ª± ki·ªán x·ª≠ l√Ω cho Modal ·∫®n S√°ch ---
        const hideModalElement = document.getElementById('confirmDeleteModal');
        if (hideModalElement) {
            const hideBookForm = document.getElementById('deleteForm');
            const submitButton = document.getElementById('confirmHideSubmitButton');
            handleBookStatusAction(hideModalElement, hideBookForm, submitButton); // G·ªçi h√†m chung
        }

        // --- G·∫Øn s·ª± ki·ªán x·ª≠ l√Ω cho Modal Kh√¥i Ph·ª•c S√°ch ---
        const restoreModalElement = document.getElementById('confirmRestoreModal');
        if (restoreModalElement) {
            const restoreBookForm = document.getElementById('restoreForm');
            const submitButton = document.getElementById('confirmRestoreSubmitButton');
            handleBookStatusAction(restoreModalElement, restoreBookForm, submitButton); // G·ªçi h√†m chung
        }

        // --- X·ª≠ l√Ω X√≥a B√¨nh Lu·∫≠n b·∫±ng AJAX ---
        const commentDeleteModal = document.getElementById('confirmDeleteCommentModal'); // Modal x√°c nh·∫≠n
        const deleteCommentForm = document.getElementById('deleteCommentForm'); // Form trong modal
        const deleteCommentSubmitButton = document.getElementById('confirmDeleteCommentSubmitButton'); // N√∫t submit trong modal

        if (commentDeleteModal && deleteCommentForm && deleteCommentSubmitButton) {
            let currentCommentId = null; // Bi·∫øn l∆∞u ID b√¨nh lu·∫≠n ƒëang x·ª≠ l√Ω

            // C·∫≠p nh·∫≠t th√¥ng tin modal tr∆∞·ªõc khi hi·ªÉn th·ªã
            commentDeleteModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; // N√∫t "X√≥a" ƒë√£ ƒë∆∞·ª£c click
                if (!button) return;
                const commentId = button.getAttribute('data-comment-id'); // L·∫•y ID t·ª´ data attribute
                const commentAuthor = button.getAttribute('data-comment-author'); // L·∫•y t√™n t√°c gi·∫£
                currentCommentId = commentId; // L∆∞u ID

                // C·∫≠p nh·∫≠t t√™n t√°c gi·∫£ trong modal
                const modalAuthorSpan = commentDeleteModal.querySelector('#modalCommentAuthor');
                if (modalAuthorSpan) modalAuthorSpan.textContent = commentAuthor || 'Ng∆∞·ªùi d√πng n√†y';
                // C·∫≠p nh·∫≠t action URL cho form trong modal
                deleteCommentForm.action = `/admin/binhluan/xoa/${commentId}`;
            });

            // G·∫Øn s·ª± ki·ªán submit AJAX cho form x√≥a b√¨nh lu·∫≠n
            deleteCommentForm.addEventListener('submit', function (event) {
                event.preventDefault(); // NgƒÉn submit m·∫∑c ƒë·ªãnh
                const formAction = deleteCommentForm.action;
                const originalButtonText = deleteCommentSubmitButton.innerHTML;
                const csrfToken = getCsrfToken();
                const headers = { 'X-CSRFToken': csrfToken };

                // V√¥ hi·ªáu h√≥a n√∫t v√† hi·ªÉn th·ªã loading
                deleteCommentSubmitButton.disabled = true;
                deleteCommentSubmitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang x√≥a...`;

                // G·ª≠i request POST b·∫±ng Fetch API
                fetch(formAction, { method: 'POST', headers: headers })
                    .then(response => { // X·ª≠ l√Ω response
                        // C·ªë g·∫Øng ƒë·ªçc JSON, tr·∫£ v·ªÅ {ok, data}
                        return response.json().then(data => ({ ok: response.ok, data }))
                            // N·∫øu kh√¥ng ph·∫£i JSON, t·∫°o ƒë·ªëi t∆∞·ª£ng l·ªói
                            .catch(() => ({ ok: false, data: { error: `L·ªói server (${response.status})` } }));
                    })
                    .then(({ ok, data }) => { // X·ª≠ l√Ω k·∫øt qu·∫£ {ok, data}
                        if (ok && data.success) {
                            // N·∫øu th√†nh c√¥ng -> X√≥a th·∫ª <li> t∆∞∆°ng ·ª©ng kh·ªèi danh s√°ch
                            const listItemToRemove = document.getElementById(`comment-${currentCommentId}`);
                            if (listItemToRemove) {
                                listItemToRemove.remove(); // X√≥a element kh·ªèi DOM
                                // Ki·ªÉm tra xem c√≤n b√¨nh lu·∫≠n n√†o kh√¥ng, n·∫øu kh√¥ng th√¨ hi·ªÉn th·ªã l·∫°i th√¥ng b√°o "Ch∆∞a c√≥ b√¨nh lu·∫≠n"
                                const commentList = document.getElementById('commentList');
                                const noCommentsLi = document.getElementById('noCommentsMessage');
                                // ƒêi·ªÅu ki·ªán: c√≤n ƒë√∫ng 1 th·∫ª li V√Ä th·∫ª ƒë√≥ l√† th·∫ª th√¥ng b√°o
                                if (commentList && noCommentsLi && commentList.children.length === 1 && commentList.firstElementChild.id === 'noCommentsMessage') {
                                    noCommentsLi.style.display = ''; // Hi·ªÉn th·ªã l·∫°i (b·ªè display: none n·∫øu c√≥)
                                } else if (commentList && !commentList.querySelector('.list-group-item:not(#noCommentsMessage)')) {
                                    // Tr∆∞·ªùng h·ª£p kh√¥ng c√≤n th·∫ª b√¨nh lu·∫≠n n√†o kh√°c
                                    if (noCommentsLi) noCommentsLi.style.display = '';
                                }
                            } else {
                                // N·∫øu kh√¥ng t√¨m th·∫•y th·∫ª li -> t·∫£i l·∫°i trang ƒë·ªÉ ƒë·∫£m b·∫£o
                                console.warn("Kh√¥ng t√¨m th·∫•y th·∫ª li ƒë·ªÉ x√≥a, s·∫Ω reload.");
                                window.location.reload();
                            }
                            // ƒê√≥ng modal
                            const modalInstance = bootstrap.Modal.getInstance(commentDeleteModal);
                            if (modalInstance) modalInstance.hide();
                            showNotification(data.message || "X√≥a b√¨nh lu·∫≠n th√†nh c√¥ng.", 'success'); // Hi·ªÉn th·ªã th√¥ng b√°o
                        } else {
                            // N·∫øu l·ªói -> N√©m l·ªói
                            throw new Error(data.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server.");
                        }
                    })
                    .catch(error => { // B·∫Øt l·ªói (t·ª´ .then ho·∫∑c fetch)
                        console.error('L·ªói khi x√≥a b√¨nh lu·∫≠n:', error);
                        showNotification(`ƒê√£ x·∫£y ra l·ªói khi x√≥a b√¨nh lu·∫≠n: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`, 'danger');
                    })
                    .finally(() => { // Lu√¥n ch·∫°y sau khi fetch ho√†n t·∫•t (th√†nh c√¥ng ho·∫∑c l·ªói)
                        // K√≠ch ho·∫°t l·∫°i n√∫t submit
                        deleteCommentSubmitButton.disabled = false;
                        deleteCommentSubmitButton.innerHTML = originalButtonText;
                    });
            });
        } // K·∫øt th√∫c if (x·ª≠ l√Ω x√≥a b√¨nh lu·∫≠n)
    }); // K·∫øt th√∫c DOMContentLoaded
</script>
{% endblock %}