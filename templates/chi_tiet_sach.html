{% extends "base.html" %} {% block title %}{{ sach.tieu_de }}{% endblock %}

{# ========================================================= #}
{# BLOCK CONTENT: N·ªôi dung ch√≠nh c·ªßa trang Chi Ti·∫øt S√°ch #}
{# Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt v·ªÅ s√°ch, ·∫£nh b√¨a, t√°c gi·∫£, th·ªÉ lo·∫°i, #}
{# ƒë√°nh gi√°, b√¨nh lu·∫≠n, n√∫t m∆∞·ª£n s√°ch v√† s√°ch li√™n quan. #}
{# ========================================================= #}
{% block content %}
{# ========================================================= #}


{# ========================================================= #}
{# KH·ªêI HI·ªÇN TH·ªä TH√îNG TIN CHI TI·∫æT S√ÅCH #}
{# ========================================================= #}
<div class="row">
    {# --- C·ªôt ·∫¢nh B√¨a --- #}
    <div class="col-lg-3 text-center mb-3">
        <img src="{{ url_for('static', filename='uploads/covers/' ~ (sach.anh_bia | default('default_cover.jpg'))) }}"
            class="img-fluid rounded shadow-sm" alt="{{ sach.tieu_de }}" style="max-height: 400px; object-fit: cover" />
    </div>

    {# --- C·ªôt Th√¥ng Tin S√°ch, ƒê√°nh Gi√°, N√∫t M∆∞·ª£n --- #}
    <div class="col-lg-5 mb-3">
        <h1>{{ sach.tieu_de }}</h1> {# Ti√™u ƒë·ªÅ s√°ch #}
        <p class="lead">T√°c gi·∫£: <strong>{{ sach.ten_tac_gia }}</strong></p>
        <hr />
        {# Danh s√°ch th√¥ng tin c∆° b·∫£n #}
        <ul class="list-unstyled">
            <li><strong>Th·ªÉ lo·∫°i:</strong> {{ sach.ten_the_loai }}</li>
            <li><strong>NƒÉm xu·∫•t b·∫£n:</strong> {{ sach.nam_xuat_ban }}</li>
            <li><strong>S·ªë trang:</strong> {{ sach.so_trang if sach.so_trang and sach.so_trang > 0 else 'Ch∆∞a c·∫≠p nh·∫≠t'
                }}</li>
            <li><strong>T·ªïng l∆∞·ª£t m∆∞·ª£n:</strong> {{ luot_muon }}</li>
            <li><strong>Hi·ªán c√≤n:</strong> <span
                    class="badge bg-{% if sach.so_luong > 0 %}success{% else %}danger{% endif %}">{{ sach.so_luong
                    }}</span></li> {# Badge s·ªë l∆∞·ª£ng c√≤n #}
        </ul>

        {# --- Hi·ªÉn th·ªã ƒê√°nh Gi√° Trung B√¨nh --- #}
        <div class="d-flex align-items-center mb-3">
            <span class="rating-stars me-2" id="averageRatingStars"></span> {# Sao trung b√¨nh (JS render) #}
            <span id="averageRatingText"> {# Text ƒëi·ªÉm trung b√¨nh v√† s·ªë l∆∞·ª£t #}
                {% if avg_rating > 0 %} {{ avg_rating }}/5 ({{ sach.so_luot_danh_gia }} ƒë√°nh gi√°)
                {% else %} Ch∆∞a c√≥ ƒë√°nh gi√° {% endif %}
            </span>
        </div>

        {# --- Kh·ªëi ƒê√°nh Gi√° C·ªßa Ng∆∞·ªùi D√πng (ch·ªâ hi·ªÉn th·ªã cho ƒë·ªôc gi·∫£) --- #}
        {% if current_user.vai_tro == 'doc_gia' %}
        <div class="mt-2">
            <h6 class="mb-1">ƒê√°nh gi√° c·ªßa b·∫°n:</h6>
            <div class="rating-input d-flex align-items-center" data-sach-id="{{ sach.id_sach }}"> {# L∆∞u ID s√°ch cho JS
                #}
                <div class="rating-stars" id="userRatingStars"> {# Container sao c·ªßa user #}
                    {# T·∫°o 5 sao (input radio ·∫©n + label icon), t√¥ m√†u d·ª±a tr√™n `user_rating` t·ª´ server #}
                    {% for i in range(5, 0, -1) %} {# L·∫∑p ng∆∞·ª£c t·ª´ 5 v·ªÅ 1 #}
                    <input type="radio" name="rating" id="star{{i}}" value="{{i}}" {% if i==user_rating %}checked{%
                        endif %}>
                    <label for="star{{i}}" class="star" title="{{i}} sao">
                        <i class="{% if i <= user_rating %}fas fa-star{% else %}far fa-star{% endif %}"></i> {# fas:
                        ƒë·∫ßy, far: r·ªóng #}
                    </label>
                    {% endfor %}
                </div>
                <span class="ms-2 text-muted" id="userRatingStatus"></span> {# N∆°i hi·ªÉn th·ªã tr·∫°ng th√°i g·ª≠i ƒë√°nh gi√° (JS
                c·∫≠p nh·∫≠t) #}
            </div>
        </div>
        {% endif %}

        {# --- Hi·ªÉn th·ªã M√¥ t·∫£ s√°ch (n·∫øu c√≥) --- #}
        {% if sach.mo_ta %}
        <div class="mt-3">
            <h5>M√¥ t·∫£</h5>
            <p style="white-space: pre-wrap">{{ sach.mo_ta }}</p> {# pre-wrap ƒë·ªÉ gi·ªØ ƒë·ªãnh d·∫°ng xu·ªëng d√≤ng #}
        </div>
        <hr />
        {% endif %}

        {# --- N√∫t M∆∞·ª£n S√°ch v√† Y√™u Th√≠ch --- #}
        <div class="input-group mt-3">
            {# N√∫t M∆∞·ª£n S√°ch (m·ªü modal) - V√¥ hi·ªáu h√≥a n·∫øu h·∫øt s√°ch #}
            {% if sach.so_luong > 0 %}
            <button type="button" class="btn btn-primary btn-lg" style="width: 85%" data-bs-toggle="modal"
                data-bs-target="#confirmMuonSachModal">
                üìö M∆∞·ª£n S√°ch N√†y
            </button>
            {% else %}
            <button type="button" class="btn btn-secondary btn-lg" style="width: 85%" disabled> ƒê√£ h·∫øt </button>
            {% endif %}
            {# N√∫t Y√™u Th√≠ch (AJAX) #}
            <button class="btn btn-outline-secondary btn-lg btn-toggle-favorite" type="button" style="width: 15%"
                data-id="{{ sach.id_sach }}" title="Th√™m v√†o y√™u th√≠ch">
                <i class="fas fa-heart btn-favorite {% if sach.is_favorite %}is-favorite{% endif %}"></i> {# Th√™m class
                is-favorite n·∫øu ƒë√£ th√≠ch #}
            </button>
        </div>
    </div> {# K·∫øt th√∫c c·ªôt th√¥ng tin s√°ch #}

    {# --- C·ªôt B√¨nh Lu·∫≠n --- #}
    <div class="col-lg-4 mb-3">
        <h4>B√¨nh Lu·∫≠n C·ªßa ƒê·ªôc Gi·∫£</h4>
        <div class="card">
            {# Danh s√°ch b√¨nh lu·∫≠n (cho ph√©p cu·ªôn) #}
            <div class="card-body comment-list p-2" id="commentListContainer"> {# ID cho JS th√™m b√¨nh lu·∫≠n m·ªõi #}
                {% for bl in binh_luan %} {# L·∫∑p qua danh s√°ch b√¨nh lu·∫≠n t·ª´ context #}
                <div class="border-bottom p-2 comment-item"> {# Class cho JS ƒë·∫øm #}
                    <strong>{{ bl.ho_ten }}</strong> {# T√™n ng∆∞·ªùi b√¨nh lu·∫≠n #}
                    <small class="text-muted float-end">{{ bl.ngay_dang.strftime('%d-%m-%Y') }}</small> {# Ng√†y ƒëƒÉng #}
                    <p class="mb-0 mt-1">{{ bl.noi_dung }}</p> {# N·ªôi dung #}
                </div>
                {% else %} {# Hi·ªÉn th·ªã n·∫øu ch∆∞a c√≥ b√¨nh lu·∫≠n #}
                <p class="text-center text-muted p-3" id="noCommentMessage"> {# ID cho JS ·∫©n ƒëi #}
                    Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!
                </p>
                {% endfor %}
            </div>
            {# Form th√™m b√¨nh lu·∫≠n m·ªõi (AJAX) #}
            <div class="card-footer">
                <form action="{{ url_for('core.them_binh_luan', id_sach=sach.id_sach) }}" method="POST"
                    id="commentForm"> {# ID cho JS #}
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" /> {# CSRF token #}
                    <div class="input-group">
                        <input type="text" class="form-control" name="noi_dung" placeholder="Vi·∫øt b√¨nh lu·∫≠n..."
                            required />
                        <button class="btn btn-outline-primary" type="submit"> G·ª≠i </button>
                    </div>
                </form>
            </div>
        </div>
    </div> {# K·∫øt th√∫c c·ªôt b√¨nh lu·∫≠n #}
</div> {# K·∫øt th√∫c row ch√≠nh #}

<hr class="my-4" />

{# ========================================================= #}
{# KH·ªêI S√ÅCH LI√äN QUAN (Cu·ªôn ngang) #}
{# ========================================================= #}
<div class="row">
    <div class="col-12">
        <h2>S√°ch C√πng Th·ªÉ Lo·∫°i & T√°c Gi·∫£</h2>
        <div class="scrolling-wrapper"> {# Container cho ph√©p cu·ªôn ngang #}
            {% for sach_lq in sach_lien_quan %} {# L·∫∑p qua danh s√°ch s√°ch li√™n quan #}
            <div class="book-card"> {# Th·∫ª s√°ch li√™n quan #}
                {# Link bao ph·ªß to√†n b·ªô th·∫ª, d·∫´n ƒë·∫øn trang chi ti·∫øt s√°ch li√™n quan #}
                <a href="{{ url_for('core.chi_tiet_sach', id_sach=sach_lq.id_sach, slug=slugify(sach_lq.tieu_de)) }}"
                    class="book-link stretched-link">
                    {# N√∫t y√™u th√≠ch nh·ªè (AJAX) #}
                    <button class="btn btn-light btn-sm btn-favorite-card btn-toggle-favorite"
                        data-id="{{ sach_lq.id_sach }}" onclick="event.preventDefault(); event.stopPropagation();"
                        title="Th√™m v√†o y√™u th√≠ch">
                        <i class="fas fa-heart {% if sach_lq.is_favorite %}is-favorite{% endif %}"></i>
                    </button>
                    {# ·∫¢nh b√¨a #}
                    <img src="{{ url_for('static', filename='uploads/covers/' ~ (sach.anh_bia | default('default_cover.jpg'))) }}"
                        class="card-img-top" alt="{{ sach_lq.tieu_de }}" />
                    {# Ti√™u ƒë·ªÅ (gi·ªõi h·∫°n 2 d√≤ng) #}
                    <div class="card-body">
                        <h6 class="card-title">{{ sach_lq.tieu_de }} {% if sach_lq.ten_tac_gia %}({{ sach_lq.ten_tac_gia
                            }}){% endif %}</h6>
                    </div>
                </a>
            </div>
            {% else %} {# Hi·ªÉn th·ªã n·∫øu kh√¥ng c√≥ s√°ch li√™n quan #}
            <p class="text-muted ms-2">Kh√¥ng t√¨m th·∫•y s√°ch li√™n quan.</p>
            {% endfor %}
        </div> {# K·∫øt th√∫c scrolling-wrapper #}
    </div>
</div>

{# ========================================================= #}
{# MODAL ƒê·∫∂T L·ªäCH M∆Ø·ª¢N S√ÅCH #}
{# Hi·ªÉn th·ªã khi ng∆∞·ªùi d√πng click n√∫t "M∆∞·ª£n S√°ch N√†y". #}
{# Ch·ª©a form ƒë·ªÉ nh·∫≠p s·ªë l∆∞·ª£ng, ng√†y l·∫•y, ng√†y tr·∫£. Submit b·∫±ng AJAX. #}
{# ========================================================= #}
<div class="modal fade" id="confirmMuonSachModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            {# Form ƒë·∫∑t l·ªãch m∆∞·ª£n s√°ch, action tr·ªè ƒë·∫øn route x·ª≠ l√Ω m∆∞·ª£n s√°ch c·ªßa user #}
            <form id="modalMuonSachForm" method="POST"
                action="{{ url_for('profile.user_muon_sach', id_sach=sach.id_sach) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" /> {# CSRF token #}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel"> ƒê·∫∑t L·ªãch M∆∞·ª£n S√°ch </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>S√°ch:</strong> {{ sach.tieu_de }}</p>
                    <p><strong>T√°c gi·∫£:</strong> {{ sach.ten_tac_gia }}</p>
                    {# Input s·ªë l∆∞·ª£ng mu·ªën m∆∞·ª£n #}
                    <div class="mb-3">
                        <label for="so_luong_muon" class="form-label">S·ªë l∆∞·ª£ng mu·ªën m∆∞·ª£n</label>
                        <input type="number" class="form-control" id="so_luong_muon" name="so_luong_muon" min="1"
                            value="1" max="{{ sach.so_luong }}" required />
                    </div>
                    {# Input ng√†y d·ª± ki·∫øn l·∫•y s√°ch #}
                    <div class="mb-3">
                        <label for="ngay_lay_sach" class="form-label">Ng√†y d·ª± ki·∫øn l·∫•y s√°ch</label>
                        <input type="date" class="form-control" id="ngay_lay_sach" name="ngay_lay_sach" required />
                    </div>
                    {# Input ng√†y d·ª± ki·∫øn tr·∫£ s√°ch #}
                    <div class="mb-3">
                        <label for="ngay_tra_sach" class="form-label">Ng√†y d·ª± ki·∫øn tr·∫£ s√°ch</label>
                        <input type="date" class="form-control" id="ngay_tra_sach" name="ngay_tra_sach" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> H·ªßy </button>
                    <button type="submit" class="btn btn-primary"> X√°c Nh·∫≠n ƒê·∫∑t L·ªãch </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %} {# K·∫øt th√∫c block content #}

{# ========================================================= #}
{# BLOCK SCRIPTS: Ch·ª©a m√£ JavaScript cho trang #}
{# Bao g·ªìm x·ª≠ l√Ω modal m∆∞·ª£n s√°ch, g·ª≠i b√¨nh lu·∫≠n, ƒë√°nh gi√° sao, y√™u th√≠ch. #}
{# ========================================================= #}
{% block scripts %}
{{ super() }} {# Nh√∫ng script t·ª´ base.html (nh∆∞ getCsrfToken, showNotification, initializeFavoriteButtons) #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // =========================================================
        // KH·ªêI 1: X·ª¨ L√ù MODAL M∆Ø·ª¢N S√ÅCH (ƒê·∫∂T L·ªäCH) - AJAX
        // =========================================================
        const confirmMuonSachModalEl = document.getElementById('confirmMuonSachModal');
        if (confirmMuonSachModalEl) {
            const confirmMuonSachModal = new bootstrap.Modal(confirmMuonSachModalEl); // Kh·ªüi t·∫°o modal
            const modalForm = confirmMuonSachModalEl.querySelector('#modalMuonSachForm'); // Form trong modal
            const submitButton = modalForm.querySelector('button[type="submit"]'); // N√∫t submit
            const ngayLayInput = modalForm.querySelector('#ngay_lay_sach'); // Input ng√†y l·∫•y
            const ngayTraInput = modalForm.querySelector('#ngay_tra_sach'); // Input ng√†y tr·∫£
            const soLuongInput = modalForm.querySelector('#so_luong_muon'); // Input s·ªë l∆∞·ª£ng

            // --- S·ª± ki·ªán tr∆∞·ªõc khi modal hi·ªÉn th·ªã: Reset form v√† ƒë·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh ---
            confirmMuonSachModalEl.addEventListener('show.bs.modal', function (event) {
                const today = new Date().toISOString().split('T')[0]; // L·∫•y ng√†y h√¥m nay
                ngayLayInput.min = today; // Ng√†y l·∫•y s·ªõm nh·∫•t l√† h√¥m nay
                ngayLayInput.value = ''; // X√≥a gi√° tr·ªã c≈©
                ngayTraInput.value = ''; // X√≥a gi√° tr·ªã c≈©
                ngayTraInput.min = null; // X√≥a r√†ng bu·ªôc ng√†y tr·∫£ c≈©
                soLuongInput.value = 1; // Reset s·ªë l∆∞·ª£ng v·ªÅ 1
                submitButton.disabled = false; // K√≠ch ho·∫°t l·∫°i n√∫t
                submitButton.innerHTML = 'X√°c Nh·∫≠n ƒê·∫∑t L·ªãch'; // Reset text n√∫t
            });

            // --- S·ª± ki·ªán thay ƒë·ªïi ng√†y l·∫•y: C·∫≠p nh·∫≠t ng√†y tr·∫£ t·ªëi thi·ªÉu ---
            ngayLayInput.addEventListener('change', function () {
                if (ngayLayInput.value) { // N·∫øu c√≥ ng√†y l·∫•y
                    let nextDay = new Date(ngayLayInput.value);
                    nextDay.setDate(nextDay.getDate() + 1); // Ng√†y tr·∫£ t·ªëi thi·ªÉu l√† ng√†y h√¥m sau
                    ngayTraInput.min = nextDay.toISOString().split('T')[0]; // C·∫≠p nh·∫≠t min
                    // N·∫øu ng√†y tr·∫£ hi·ªán t·∫°i kh√¥ng h·ª£p l·ªá -> ƒë·∫∑t l·∫°i
                    if (ngayTraInput.value && ngayTraInput.value < ngayTraInput.min) {
                        ngayTraInput.value = ngayTraInput.min;
                    }
                } else {
                    ngayTraInput.min = null; // X√≥a min n·∫øu ng√†y l·∫•y r·ªóng
                }
            });

            // --- X·ª≠ l√Ω submit form m∆∞·ª£n s√°ch b·∫±ng AJAX ---
            modalForm.addEventListener('submit', async function (event) {
                event.preventDefault(); // NgƒÉn submit truy·ªÅn th·ªëng
                // Hi·ªÉn th·ªã loading
                const btnOriginalText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...`;
                // Chu·∫©n b·ªã d·ªØ li·ªáu v√† header
                const formData = new FormData(modalForm);
                const csrfToken = getCsrfToken();
                const headers = { 'X-CSRFToken': csrfToken };

                try {
                    // G·ª≠i request POST
                    const response = await fetch(modalForm.action, { method: 'POST', body: formData, headers: headers });
                    const data = await response.json();
                    confirmMuonSachModal.hide(); // ƒê√≥ng modal

                    if (response.ok && data.success) { // N·∫øu th√†nh c√¥ng
                        showNotification(data.message, 'success'); // Hi·ªÉn th·ªã th√¥ng b√°o

                        // --- C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s√°ch c√≤n l·∫°i tr√™n giao di·ªán ---
                        const currentQuantityBadge = document.querySelector('.list-unstyled .badge'); // T√¨m badge s·ªë l∆∞·ª£ng
                        if (currentQuantityBadge) {
                            let currentQuantity = parseInt(currentQuantityBadge.textContent) || 0;
                            const borrowedQuantity = parseInt(soLuongInput.value) || 0;
                            const newQuantity = Math.max(0, currentQuantity - borrowedQuantity); // T√≠nh s·ªë l∆∞·ª£ng m·ªõi
                            currentQuantityBadge.textContent = newQuantity; // C·∫≠p nh·∫≠t text badge
                            if (newQuantity <= 0) { // N·∫øu h·∫øt s√°ch
                                // ƒê·ªïi m√†u badge th√†nh ƒë·ªè
                                currentQuantityBadge.classList.remove('bg-success');
                                currentQuantityBadge.classList.add('bg-danger');
                                // V√¥ hi·ªáu h√≥a n√∫t m∆∞·ª£n ch√≠nh
                                const mainBorrowButton = document.querySelector('button[data-bs-target="#confirmMuonSachModal"]');
                                if (mainBorrowButton) {
                                    mainBorrowButton.disabled = true;
                                    mainBorrowButton.textContent = 'ƒê√£ h·∫øt';
                                    mainBorrowButton.classList.replace('btn-primary', 'btn-secondary');
                                }
                            }
                        }
                    } else { // N·∫øu l·ªói t·ª´ server
                        throw new Error(data.error || `L·ªói server: ${response.status}.`);
                    }
                } catch (error) { // X·ª≠ l√Ω l·ªói
                    console.error('L·ªói khi ƒë·∫∑t l·ªãch m∆∞·ª£n s√°ch:', error);
                    showNotification(`L·ªói: ${error.message}`, 'danger');
                } finally { // Lu√¥n ch·∫°y
                    // K√≠ch ho·∫°t l·∫°i n√∫t submit
                    submitButton.disabled = false;
                    submitButton.innerHTML = btnOriginalText;
                }
            });
        } // K·∫øt th√∫c if (confirmMuonSachModalEl)

        // =========================================================
        // KH·ªêI 2: X·ª¨ L√ù G·ª¨I B√åNH LU·∫¨N - AJAX
        // =========================================================
        const commentForm = document.getElementById('commentForm');
        if (commentForm) {
            const commentInput = commentForm.querySelector('input[name="noi_dung"]'); // Input n·ªôi dung
            const commentListContainer = document.getElementById('commentListContainer'); // V√πng ch·ª©a danh s√°ch
            const noCommentMessage = document.getElementById('noCommentMessage'); // Th√¥ng b√°o "ch∆∞a c√≥"
            const commentSubmitButton = commentForm.querySelector('button[type="submit"]'); // N√∫t g·ª≠i

            // --- X·ª≠ l√Ω submit form b√¨nh lu·∫≠n b·∫±ng AJAX ---
            commentForm.addEventListener('submit', async function (event) {
                event.preventDefault(); // NgƒÉn submit truy·ªÅn th·ªëng
                const noiDung = commentInput.value.trim();
                if (!noiDung) return; // Kh√¥ng g·ª≠i n·∫øu r·ªóng

                // Hi·ªÉn th·ªã loading
                const btnOriginalHtml = commentSubmitButton.innerHTML; // L∆∞u l·∫°i HTML g·ªëc (c√≥ th·ªÉ l√† icon)
                commentSubmitButton.disabled = true;
                commentSubmitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
                // Chu·∫©n b·ªã d·ªØ li·ªáu v√† header
                const formData = new FormData(commentForm);
                const csrfToken = getCsrfToken();
                const headers = { 'X-CSRFToken': csrfToken };

                try {
                    // G·ª≠i POST request
                    const response = await fetch(commentForm.action, { method: 'POST', body: formData, headers: headers });
                    const data = await response.json();

                    if (response.ok && data.success) { // N·∫øu th√†nh c√¥ng
                        showNotification(data.message, 'success');
                        commentInput.value = ''; // X√≥a input

                        // --- Th√™m b√¨nh lu·∫≠n m·ªõi v√†o danh s√°ch (ph√≠a tr√™n c√πng) ---
                        const newCommentHtml = `
                            <div class="border-bottom p-2 comment-item">
                                <strong>${data.user_name || 'B·∫°n'}</strong> {# T√™n user #}
                                <small class="text-muted float-end">${data.comment_date || 'Ngay b√¢y gi·ªù'}</small> {# Ng√†y #}
                                <p class="mb-0 mt-1">${data.comment_content || noiDung}</p> {# N·ªôi dung #}
                            </div>`;
                        // Th√™m v√†o ƒë·∫ßu danh s√°ch (sau th·∫ª div card-body)
                        commentListContainer.insertAdjacentHTML('afterbegin', newCommentHtml);

                        // ·∫®n th√¥ng b√°o "ch∆∞a c√≥ b√¨nh lu·∫≠n" n·∫øu ƒëang hi·ªÉn th·ªã
                        if (noCommentMessage && noCommentMessage.offsetParent !== null) { // Ki·ªÉm tra xem c√≥ ƒëang hi·ªÉn th·ªã kh√¥ng
                            noCommentMessage.style.display = 'none';
                        }
                    } else { // N·∫øu l·ªói t·ª´ server
                        throw new Error(data.error || `L·ªói server: ${response.status}.`);
                    }
                } catch (error) { // X·ª≠ l√Ω l·ªói
                    console.error('L·ªói khi g·ª≠i b√¨nh lu·∫≠n:', error);
                    showNotification(`L·ªói g·ª≠i b√¨nh lu·∫≠n: ${error.message}`, 'danger');
                } finally { // Lu√¥n ch·∫°y
                    // K√≠ch ho·∫°t l·∫°i n√∫t g·ª≠i
                    commentSubmitButton.disabled = false;
                    commentSubmitButton.innerHTML = btnOriginalHtml; // Tr·∫£ l·∫°i HTML g·ªëc
                }
            });
        } // K·∫øt th√∫c if (commentForm)

        // =========================================================
        // KH·ªêI 3: X·ª¨ L√ù SAO ƒê√ÅNH GI√Å - AJAX V√Ä HI·ªÜU ·ª®NG HOVER
        // =========================================================
        const avgRatingStarsContainer = document.getElementById('averageRatingStars'); // Sao trung b√¨nh
        const avgRatingTextSpan = document.getElementById('averageRatingText'); // Text trung b√¨nh
        const userRatingStarsContainer = document.getElementById('userRatingStars'); // Sao c·ªßa user
        const userRatingStatusSpan = document.getElementById('userRatingStatus'); // Text tr·∫°ng th√°i

        /** H√†m render c√°c icon sao (ƒë·∫ßy/r·ªóng) v√†o container */
        function renderStars(container, rating, readOnly = false) {
            if (!container) return;
            container.innerHTML = ''; // X√≥a sao c≈©
            let avgRounded = Math.round(rating * 2) / 2; // L√†m tr√≤n ƒë·∫øn 0.5 (cho n·ª≠a sao n·∫øu c·∫ßn)
            for (let i = 1; i <= 5; i++) {
                let starClass = (i <= avgRounded) ? 'fas fa-star' : 'far fa-star'; // Ch·ªçn icon ƒë·∫ßy ho·∫∑c r·ªóng
                // (C√≥ th·ªÉ th√™m 'fa-star-half-alt' n·∫øu avgRounded c√≥ .5)
                const starIcon = document.createElement('i');
                starIcon.className = starClass;
                if (!readOnly) starIcon.style.margin = '0 1px'; // Th√™m margin n·∫øu l√† sao t∆∞∆°ng t√°c
                container.appendChild(starIcon);
            }
        }

        /** H√†m c·∫≠p nh·∫≠t giao di·ªán sau khi ƒë√°nh gi√° th√†nh c√¥ng */
        function updateUserRatingUI(newAvgRating, newRatingCount, userNewRating) {
            // C·∫≠p nh·∫≠t sao v√† text trung b√¨nh
            renderStars(avgRatingStarsContainer, newAvgRating, true); // Render l·∫°i sao trung b√¨nh (read-only)
            if (avgRatingTextSpan) { // C·∫≠p nh·∫≠t text
                avgRatingTextSpan.textContent = (newRatingCount > 0)
                    ? `${newAvgRating.toFixed(1)}/5 (${newRatingCount} ƒë√°nh gi√°)`
                    : 'Ch∆∞a c√≥ ƒë√°nh gi√°';
            }
            // C·∫≠p nh·∫≠t sao c·ªßa ng∆∞·ªùi d√πng
            if (userRatingStarsContainer) {
                const labels = userRatingStarsContainer.querySelectorAll('label.star');
                labels.forEach(label => {
                    const starInput = document.getElementById(label.getAttribute('for')); // Radio button t∆∞∆°ng ·ª©ng
                    const starIcon = label.querySelector('i'); // Icon sao
                    if (starInput && starIcon) {
                        const starValue = parseInt(starInput.value);
                        starInput.checked = (starValue === userNewRating); // Check ƒë√∫ng radio
                        // C·∫≠p nh·∫≠t icon ƒë·∫ßy/r·ªóng
                        starIcon.className = (starValue <= userNewRating) ? 'fas fa-star' : 'far fa-star';
                        label.classList.add('rated'); // ƒê√°nh d·∫•u ƒë√£ ƒë√°nh gi√°
                    }
                });
            }
        }

        // Render sao trung b√¨nh ban ƒë·∫ßu khi t·∫£i trang
        const initialAvgRating = parseFloat('{{ avg_rating | default (0) }}'); // L·∫•y ƒëi·ªÉm trung b√¨nh t·ª´ context
        renderStars(avgRatingStarsContainer, initialAvgRating, true); // Render sao ch·ªâ ƒë·ªçc

        // --- G·∫Øn s·ª± ki·ªán cho sao ƒë√°nh gi√° c·ªßa ng∆∞·ªùi d√πng (n·∫øu l√† ƒë·ªôc gi·∫£) ---
        if (userRatingStarsContainer) {
            const sachId = userRatingStarsContainer.closest('.rating-input').dataset.sachId; // L·∫•y ID s√°ch
            const stars = userRatingStarsContainer.querySelectorAll('label.star'); // L·∫•y t·∫•t c·∫£ label sao

            stars.forEach(starLabel => {
                // --- S·ª± ki·ªán click v√†o sao: G·ª≠i ƒë√°nh gi√° AJAX ---
                starLabel.addEventListener('click', async function (event) {
                    // Label t·ª± ƒë·ªông check radio button, kh√¥ng c·∫ßn preventDefault
                    const ratingValue = parseInt(this.getAttribute('for').replace('star', '')); // L·∫•y ƒëi·ªÉm (1-5)
                    if (!ratingValue || !sachId) return;

                    // Hi·ªÉn th·ªã tr·∫°ng th√°i v√† v√¥ hi·ªáu h√≥a sao
                    if (userRatingStatusSpan) userRatingStatusSpan.textContent = 'ƒêang g·ª≠i...';
                    stars.forEach(s => s.style.pointerEvents = 'none'); // NgƒÉn click li√™n t·ª•c
                    // Chu·∫©n b·ªã d·ªØ li·ªáu v√† header
                    const formData = new FormData(); formData.append('rating', ratingValue);
                    const csrfToken = getCsrfToken(); const headers = { 'X-CSRFToken': csrfToken };

                    try {
                        // G·ª≠i POST request ƒë·∫øn API ƒë√°nh gi√°
                        const response = await fetch(`/api/sach/${sachId}/rate`, { method: 'POST', body: formData, headers: headers });
                        const data = await response.json();
                        if (response.ok && data.success) { // N·∫øu th√†nh c√¥ng
                            showNotification(data.message, 'success');
                            // C·∫≠p nh·∫≠t giao di·ªán (sao trung b√¨nh, sao user, text)
                            updateUserRatingUI(data.avg_rating, data.rating_count, ratingValue);
                            if (userRatingStatusSpan) userRatingStatusSpan.textContent = 'ƒê√£ l∆∞u!';
                            // X√≥a tr·∫°ng th√°i sau 2 gi√¢y
                            setTimeout(() => { if (userRatingStatusSpan) userRatingStatusSpan.textContent = ''; }, 2000);
                        } else { // N·∫øu l·ªói
                            throw new Error(data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                        }
                    } catch (error) { // X·ª≠ l√Ω l·ªói
                        console.error('L·ªói khi ƒë√°nh gi√°:', error);
                        showNotification(`L·ªói ƒë√°nh gi√°: ${error.message}`, 'danger');
                        if (userRatingStatusSpan) userRatingStatusSpan.textContent = 'L·ªói!';
                        setTimeout(() => { if (userRatingStatusSpan) userRatingStatusSpan.textContent = ''; }, 2000);
                        // C·∫ßn th√™m logic reset sao v·ªÅ tr·∫°ng th√°i c≈© n·∫øu l·ªói
                        const currentRatingBeforeClick = parseInt('{{ user_rating | default(0) }}');
                        updateUserRatingUI(initialAvgRating, parseInt('{{ sach.so_luot_danh_gia | default(0) }}'), currentRatingBeforeClick);

                    } finally { // Lu√¥n ch·∫°y
                        // K√≠ch ho·∫°t l·∫°i c√°c sao
                        stars.forEach(s => s.style.pointerEvents = '');
                    }
                }); // K·∫øt th√∫c event click

                // --- Hi·ªáu ·ª©ng hover cho sao ---
                starLabel.addEventListener('mouseover', function () {
                    // if (this.classList.contains('rated')) return; // B·ªè qua n·∫øu ƒë√£ ƒë√°nh gi√°
                    const ratingValue = parseInt(this.getAttribute('for').replace('star', ''));
                    // T√¥ m√†u c√°c sao t·ª´ ƒë·∫ßu ƒë·∫øn sao ƒëang hover
                    stars.forEach(s => {
                        const val = parseInt(s.getAttribute('for').replace('star', ''));
                        const icon = s.querySelector('i');
                        icon.className = (val <= ratingValue) ? 'fas fa-star hovered' : 'far fa-star hovered'; // Th√™m class hovered
                    });
                });

                // --- Reset hi·ªáu ·ª©ng hover khi chu·ªôt r·ªùi kh·ªèi ---
                starLabel.addEventListener('mouseout', function () {
                    // if (this.classList.contains('rated')) return;
                    let currentCheckedValue = 0; // T√¨m ƒëi·ªÉm hi·ªán t·∫°i ƒë√£ ch·ªçn (n·∫øu c√≥)
                    const checkedInput = userRatingStarsContainer.querySelector('input[name="rating"]:checked');
                    if (checkedInput) { currentCheckedValue = parseInt(checkedInput.value); }
                    // Reset m√†u sao theo ƒëi·ªÉm ƒë√£ ch·ªçn
                    stars.forEach(s => {
                        const val = parseInt(s.getAttribute('for').replace('star', ''));
                        const icon = s.querySelector('i');
                        icon.classList.remove('hovered'); // X√≥a class hovered
                        icon.className = (val <= currentCheckedValue) ? 'fas fa-star' : 'far fa-star'; // ƒê·∫∑t l·∫°i fas/far
                    });
                });
            }); // K·∫øt th√∫c l·∫∑p qua c√°c sao
        } // K·∫øt th√∫c if (userRatingStarsContainer)

        // =========================================================
        // KH·ªêI 4: KH·ªûI T·∫†O N√öT Y√äU TH√çCH
        // =========================================================
        // G·ªçi h√†m initializeFavoriteButtons t·ª´ base.html ƒë·ªÉ g·∫Øn s·ª± ki·ªán AJAX
        // cho t·∫•t c·∫£ c√°c n√∫t y√™u th√≠ch tr√™n trang (c·∫£ n√∫t l·ªõn v√† n√∫t nh·ªè).
        if (typeof initializeFavoriteButtons === 'function') {
            initializeFavoriteButtons();
        } else {
            console.error("H√†m initializeFavoriteButtons kh√¥ng t·ªìn t·∫°i trong base.html");
        }

    }); // K·∫øt th√∫c DOMContentLoaded
</script>
{% endblock %} {# K·∫øt th√∫c block scripts #}