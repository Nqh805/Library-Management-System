{% extends "base.html" %} {# K·∫ø th·ª´a layout t·ª´ base.html #}
{% block title %}Trang Ch·ªß{% endblock %} {# ƒê·∫∑t ti√™u ƒë·ªÅ trang #}

{# ========================================================= #}
{# BLOCK CONTENT: N·ªôi dung ch√≠nh c·ªßa Trang Ch·ªß #}
{# Hi·ªÉn th·ªã l·ªùi ch√†o m·ª´ng, form t√¨m ki·∫øm nhanh/l·ªçc. #}
{# T√πy thu·ªôc v√†o vi·ªác c√≥ ƒëang t√¨m ki·∫øm hay kh√¥ng, trang s·∫Ω hi·ªÉn th·ªã: #}
{# - K·∫øt qu·∫£ t√¨m ki·∫øm d·∫°ng l∆∞·ªõi c√≥ ph√¢n trang. #}
{# - Ho·∫∑c c√°c danh s√°ch s√°ch cu·ªôn ngang m·∫∑c ƒë·ªãnh (M·ªõi nh·∫•t, Ph·ªï bi·∫øn, G·ª£i √Ω). #}
{# ========================================================= #}
{% block content %}

{# --- L·ªùi ch√†o m·ª´ng (n·∫øu ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p) --- #}
{% if current_user.is_authenticated %}
<h2 class="mb-4">üëã Ch√†o m·ª´ng, {{ current_user.ho_ten }}!</h2>
{% endif %}

{# ========================================================= #}
{# KH·ªêI T√åM KI·∫æM NHANH V√Ä L·ªåC #}
{# Ch·ª©a form t√¨m ki·∫øm (v·ªõi live search), dropdown l·ªçc Th·ªÉ lo·∫°i, T√°c gi·∫£. #}
{# ========================================================= #}
<section class="mb-4 p-3 bg-light rounded shadow-sm">
    <h2 class="h5 mb-3">T√¨m Ki·∫øm S√°ch Nhanh</h2>
    {# Form g·ª≠i request GET ƒë·∫øn ch√≠nh trang ch·ªß ƒë·ªÉ th·ª±c hi·ªán t√¨m ki·∫øm/l·ªçc #}
    <form method="GET" action="{{ url_for('core.index') }}">
        <div class="row g-2 align-items-end">
            {# --- Input t√¨m ki·∫øm (v·ªõi Live Search) --- #}
            <div class="col-lg-4 mb-2 position-relative"> {# position-relative cho dropdown k·∫øt qu·∫£ #}
                <label for="search-input-home" class="form-label visually-hidden">T√¨m ki·∫øm</label>
                {# autocomplete="off" ƒë·ªÉ kh√¥ng xung ƒë·ªôt v·ªõi live search #}
                <input type="text" class="form-control form-control-sm" name="search" id="search-input-home"
                    placeholder="Nh·∫≠p ti√™u ƒë·ªÅ, t√°c gi·∫£..." autocomplete="off" value="{{ search_query | default('') }}">
                {# Dropdown hi·ªÉn th·ªã k·∫øt qu·∫£ live search (JS ƒëi·ªÅu khi·ªÉn) #}
                <div class="dropdown-menu w-100 live-search-results" id="search-results-home"
                    aria-labelledby="search-input-home">
                    {# K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c JS ch√®n v√†o ƒë√¢y #}
                </div>
            </div>
            {# --- Dropdown l·ªçc Th·ªÉ lo·∫°i (TomSelect) --- #}
            <div class="col-lg-3 mb-2">
                <label for="select-the-loai-home" class="form-label visually-hidden">Th·ªÉ lo·∫°i</label>
                <select id="select-the-loai-home" name="id_the_loai" class="form-select-sm"
                    placeholder="Ch·ªçn th·ªÉ lo·∫°i...">
                    <option value="">T·∫•t c·∫£ Th·ªÉ Lo·∫°i</option>
                    {% for tl in danh_sach_the_loai %} {# L·∫•y danh s√°ch t·ª´ context #}
                    <option value="{{ tl.id_the_loai }}" {% if tl.id_the_loai|string==selected_the_loai %}selected{%
                        endif %}> {# Gi·ªØ l·∫°i l·ª±a ch·ªçn c≈© #}
                        {{ tl.ten_the_loai }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {# --- Dropdown l·ªçc T√°c gi·∫£ (TomSelect) --- #}
            <div class="col-lg-3 mb-2">
                <label for="select-tac-gia-home" class="form-label visually-hidden">T√°c gi·∫£</label>
                <select id="select-tac-gia-home" name="id_tac_gia" class="form-select-sm" placeholder="Ch·ªçn t√°c gi·∫£...">
                    <option value="">T·∫•t c·∫£ T√°c Gi·∫£</option>
                    {% for tg in danh_sach_tac_gia %} {# L·∫•y danh s√°ch t·ª´ context #}
                    <option value="{{ tg.id_tac_gia }}" {% if tg.id_tac_gia|string==selected_tac_gia %}selected{% endif
                        %}> {# Gi·ªØ l·∫°i l·ª±a ch·ªçn c≈© #}
                        {{ tg.ten_tac_gia }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {# --- N√∫t Submit Form --- #}
            <div class="col-lg-2 mb-2">
                <button class="btn btn-primary btn-sm w-100" type="submit">
                    <i class="fas fa-search"></i> <span class="d-none d-xl-inline">T√¨m</span> {# ·∫®n ch·ªØ "T√¨m" tr√™n m√†n
                    h√¨nh nh·ªè #}
                </button>
            </div>
        </div>
    </form>
</section>

{# ========================================================= #}
{# KH·ªêI HI·ªÇN TH·ªä N·ªòI DUNG CH√çNH (T√πy thu·ªôc is_searching) #}
{# ========================================================= #}

{# --- A. N·∫øu ƒêANG T√åM KI·∫æM/L·ªåC --- #}
{% if is_searching %}
<section class="mb-5">
    <h2 class="h4 section-title"><i class="fas fa-search"></i> {{ search_title }}</h2> {# Ti√™u ƒë·ªÅ k·∫øt qu·∫£ t√¨m ki·∫øm #}

    {# --- Hi·ªÉn th·ªã k·∫øt qu·∫£ d·∫°ng l∆∞·ªõi (Grid) --- #}
    <div class="row g-3 mt-1"> {# g-3 t·∫°o kho·∫£ng c√°ch gi·ªØa c√°c c·ªôt #}
        {% for sach in search_results_paginated %} {# L·∫∑p qua k·∫øt qu·∫£ ƒë√£ ph√¢n trang #}
        {# C·∫•u h√¨nh c·ªôt cho c√°c k√≠ch th∆∞·ªõc m√†n h√¨nh kh√°c nhau (responsive grid) #}
        <div class="col-6 col-md-4 col-lg-3 col-xl-2 mb-3">
            <div class="book-card h-100"> {# h-100 ƒë·ªÉ c√°c th·∫ª c√≥ chi·ªÅu cao b·∫±ng nhau #}
                {# Link bao ph·ªß th·∫ª, d·∫´n ƒë·∫øn trang chi ti·∫øt #}
                <a href="{{ url_for('core.chi_tiet_sach', id_sach=sach.id_sach, slug=slugify(sach.tieu_de)) }}"
                    class="book-link stretched-link">
                    {# N√∫t y√™u th√≠ch nh·ªè #}
                    <button class="btn btn-light btn-sm btn-favorite-card btn-toggle-favorite"
                        data-id="{{ sach.id_sach }}" onclick="event.preventDefault(); event.stopPropagation();"
                        title="Th√™m v√†o y√™u th√≠ch">
                        <i class="fas fa-heart {% if sach.is_favorite %}is-favorite{% endif %}"></i> {# Th√™m class
                        is-favorite n·∫øu ƒë√£ th√≠ch #}
                    </button>
                    {# ·∫¢nh b√¨a #}
                    <img src="{{ url_for('static', filename='uploads/covers/' ~ (sach.anh_bia | default('default_cover.jpg'))) }}"
                        class="card-img-top" alt="{{ sach.tieu_de }}"> {# D√πng ·∫£nh default n·∫øu kh√¥ng c√≥ #}
                    {# Ti√™u ƒë·ªÅ s√°ch #}
                    <div class="card-body">
                        <h6 class="card-title">{{ sach.tieu_de }} {% if sach.ten_tac_gia %}({{ sach.ten_tac_gia }}){%
                            endif %}</h6>
                    </div>
                </a>
            </div>
        </div>
        {% else %} {# Hi·ªÉn th·ªã n·∫øu kh√¥ng c√≥ k·∫øt qu·∫£ t√¨m ki·∫øm #}
        <div class="col-12">
            <div class="alert alert-info" role="alert"> Kh√¥ng t√¨m th·∫•y s√°ch n√†o ph√π h·ª£p v·ªõi l·ª±a ch·ªçn c·ªßa b·∫°n. </div>
        </div>
        {% endfor %}
    </div> {# K·∫øt th√∫c row ch·ª©a k·∫øt qu·∫£ #}

    {# --- Ph√¢n trang cho k·∫øt qu·∫£ t√¨m ki·∫øm --- #}
    {% if total_search_pages > 1 %} {# Ch·ªâ hi·ªÉn th·ªã n·∫øu c√≥ nhi·ªÅu h∆°n 1 trang #}
    <nav aria-label="Search Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {# N√∫t L√πi #}
            <li class="page-item {% if current_search_page == 1 %}disabled{% endif %}">
                {# URL gi·ªØ nguy√™n c√°c tham s·ªë t√¨m ki·∫øm/l·ªçc, ch·ªâ thay ƒë·ªïi search_page #}
                <a class="page-link"
                    href="{{ url_for('core.index', search_page=current_search_page - 1, search=search_query, id_the_loai=selected_the_loai, id_tac_gia=selected_tac_gia) }}">&laquo;</a>
            </li>
            {# Logic hi·ªÉn th·ªã s·ªë trang v√† d·∫•u ... (t∆∞∆°ng t·ª± macro ·ªü admin_muontra.html) #}
            {% set start_page = [1, current_search_page - 2] | max %}
            {% set end_page = [total_search_pages, current_search_page + 2] | min %}
            {% if start_page > 1 %}
            <li class="page-item"><a class="page-link"
                    href="{{ url_for('core.index', search_page=1, search=search_query, id_the_loai=selected_the_loai, id_tac_gia=selected_tac_gia) }}">1</a>
            </li>
            {% if start_page > 2 %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}
            {% endif %}
            {% for p in range(start_page, end_page + 1) %}
            <li class="page-item {% if p == current_search_page %}active{% endif %}">
                <a class="page-link"
                    href="{{ url_for('core.index', search_page=p, search=search_query, id_the_loai=selected_the_loai, id_tac_gia=selected_tac_gia) }}">{{
                    p }}</a>
            </li>
            {% endfor %}
            {% if end_page < total_search_pages %} {% if end_page < total_search_pages - 1 %}<li
                class="page-item disabled"><span class="page-link">...</span></li>{% endif %}
                <li class="page-item"><a class="page-link"
                        href="{{ url_for('core.index', search_page=total_search_pages, search=search_query, id_the_loai=selected_the_loai, id_tac_gia=selected_tac_gia) }}">{{
                        total_search_pages }}</a></li>
                {% endif %}
                {# N√∫t Ti·∫øn #}
                <li class="page-item {% if current_search_page == total_search_pages %}disabled{% endif %}">
                    <a class="page-link"
                        href="{{ url_for('core.index', search_page=current_search_page + 1, search=search_query, id_the_loai=selected_the_loai, id_tac_gia=selected_tac_gia) }}">&raquo;</a>
                </li>
        </ul>
    </nav>
    {% endif %} {# K·∫øt th√∫c ph√¢n trang t√¨m ki·∫øm #}

</section> {# K·∫øt th√∫c section k·∫øt qu·∫£ t√¨m ki·∫øm #}

{# --- B. N·∫øu KH√îNG T√åM KI·∫æM/L·ªåC (Hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh) --- #}
{% else %}
{# --- Section: S√°ch M·ªõi Nh·∫•t --- #}
<section class="mb-5">
    <h2 class="h4 section-title"><i class="fas fa-book-open"></i> S√°ch M·ªõi Nh·∫•t</h2>
    <div class="scrolling-wrapper"> {# Khu v·ª±c cu·ªôn ngang #}
        {% for sach in sach_moi_nhat %} {# L·∫∑p qua danh s√°ch s√°ch m·ªõi #}
        <div class="book-card"> {# Th·∫ª s√°ch #}
            <a href="{{ url_for('core.chi_tiet_sach', id_sach=sach.id_sach, slug=slugify(sach.tieu_de)) }}"
                class="book-link stretched-link">
                <button class="btn btn-light btn-sm btn-favorite-card btn-toggle-favorite" data-id="{{ sach.id_sach }}"
                    onclick="event.preventDefault(); event.stopPropagation();" title="Th√™m v√†o y√™u th√≠ch">
                    <i class="fas fa-heart {% if sach.is_favorite %}is-favorite{% endif %}"></i>
                </button>
                <img src="{{ url_for('static', filename='uploads/covers/' ~ (sach.anh_bia | default('default_cover.jpg'))) }}"
                    class="card-img-top" alt="{{ sach.tieu_de }}">
                <div class="card-body">
                    <h6 class="card-title">{{ sach.tieu_de }} {% if sach.ten_tac_gia %}({{ sach.ten_tac_gia }}){% endif
                        %}</h6>
                </div>
            </a>
        </div>
        {% else %} {# Hi·ªÉn th·ªã n·∫øu danh s√°ch r·ªóng #}
        <p class="text-muted ms-2">Ch∆∞a c√≥ s√°ch m·ªõi.</p>
        {% endfor %}
    </div>
</section>

{# --- Section: S√°ch M∆∞·ª£n Nhi·ªÅu Nh·∫•t --- #}
<section class="mb-5">
    <h2 class="h4 section-title"><i class="fas fa-star"></i> S√°ch M∆∞·ª£n Nhi·ªÅu Nh·∫•t</h2>
    <div class="scrolling-wrapper">
        {% for sach in sach_pho_bien %} {# L·∫∑p qua danh s√°ch s√°ch ph·ªï bi·∫øn #}
        <div class="book-card">
            <a href="{{ url_for('core.chi_tiet_sach', id_sach=sach.id_sach, slug=slugify(sach.tieu_de)) }}"
                class="book-link stretched-link">
                <button class="btn btn-light btn-sm btn-favorite-card btn-toggle-favorite" data-id="{{ sach.id_sach }}"
                    onclick="event.preventDefault(); event.stopPropagation();" title="Th√™m v√†o y√™u th√≠ch">
                    <i class="fas fa-heart {% if sach.is_favorite %}is-favorite{% endif %}"></i>
                </button>
                <img src="{{ url_for('static', filename='uploads/covers/' ~ (sach.anh_bia | default('default_cover.jpg'))) }}"
                    class="card-img-top" alt="{{ sach.tieu_de }}">
                <div class="card-body">
                    <h6 class="card-title">{{ sach.tieu_de }} {% if sach.ten_tac_gia %}({{ sach.ten_tac_gia }}){% endif
                        %}</h6>
                </div>
            </a>
        </div>
        {% else %} {# Hi·ªÉn th·ªã n·∫øu danh s√°ch r·ªóng #}
        <p class="text-muted ms-2">Ch∆∞a c√≥ ƒë·ªß d·ªØ li·ªáu v·ªÅ s√°ch m∆∞·ª£n nhi·ªÅu nh·∫•t.</p>
        {% endfor %}
    </div>
</section>

{# --- Section: S√°ch G·ª£i √ù (D√†nh Ri√™ng Cho B·∫°n) --- #}
<section class="mb-5">
    <h2 class="h4 section-title"><i class="fas fa-magic"></i> D√†nh Ri√™ng Cho B·∫°n</h2>
    <p class="text-muted small ms-2 mt-n2">D·ª±a tr√™n nh·ªØng th·ªÉ lo·∫°i b·∫°n th∆∞·ªùng m∆∞·ª£n.</p> {# Ch√∫ th√≠ch nh·ªè #}
    <div class="scrolling-wrapper">
        {% for sach in sach_goi_y %} {# L·∫∑p qua danh s√°ch s√°ch g·ª£i √Ω #}
        <div class="book-card">
            <a href="{{ url_for('core.chi_tiet_sach', id_sach=sach.id_sach, slug=slugify(sach.tieu_de)) }}"
                class="book-link stretched-link">
                <button class="btn btn-light btn-sm btn-favorite-card btn-toggle-favorite" data-id="{{ sach.id_sach }}"
                    onclick="event.preventDefault(); event.stopPropagation();" title="Th√™m v√†o y√™u th√≠ch">
                    <i class="fas fa-heart {% if sach.is_favorite %}is-favorite{% endif %}"></i>
                </button>
                <img src="{{ url_for('static', filename='uploads/covers/' ~ (sach.anh_bia | default('default_cover.jpg'))) }}"
                    class="card-img-top" alt="{{ sach.tieu_de }}">
                <div class="card-body">
                    <h6 class="card-title">{{ sach.tieu_de }} {% if sach.ten_tac_gia %}({{ sach.ten_tac_gia }}){% endif
                        %}</h6>
                </div>
            </a>
        </div>
        {% else %} {# Hi·ªÉn th·ªã n·∫øu danh s√°ch r·ªóng #}
        <p class="text-muted ms-2">Ch∆∞a c√≥ s√°ch g·ª£i √Ω cho b·∫°n.</p>
        {% endfor %}
    </div>
</section>
{% endif %} {# K·∫øt th√∫c kh·ªëi else (hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh) #}

{% endblock %} {# K·∫øt th√∫c block content #}


{# ========================================================= #}
{# BLOCK SCRIPTS: Ch·ª©a m√£ JavaScript cho trang #}
{# Kh·ªüi t·∫°o TomSelect, Live Search, v√† N√∫t Y√™u th√≠ch. #}
{# ========================================================= #}
{% block scripts %}
{{ super() }} {# Nh√∫ng script t·ª´ base.html (ch·ª©a c√°c h√†m kh·ªüi t·∫°o) #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Kh·ªüi t·∫°o TomSelect cho dropdown l·ªçc Th·ªÉ lo·∫°i v√† T√°c gi·∫£ ---
        // G·ªçi h√†m initializeSearchableSelect t·ª´ base.html
        if (typeof initializeSearchableSelect === 'function') {
            initializeSearchableSelect('#select-the-loai-home');
            initializeSearchableSelect('#select-tac-gia-home');
        } else { console.error("H√†m initializeSearchableSelect kh√¥ng t·ªìn t·∫°i."); }

        // --- Kh·ªüi t·∫°o ch·ª©c nƒÉng Live Search ---
        // G·ªçi h√†m initializeLiveSearch t·ª´ base.html
        if (typeof initializeLiveSearch === 'function') {
            initializeLiveSearch('search-input-home', 'search-results-home'); // ID √¥ input v√† ID dropdown k·∫øt qu·∫£
        } else { console.error("H√†m initializeLiveSearch kh√¥ng t·ªìn t·∫°i."); }

        // --- Kh·ªüi t·∫°o ch·ª©c nƒÉng cho c√°c N√∫t Y√™u th√≠ch ---
        // G·ªçi h√†m initializeFavoriteButtons t·ª´ base.html
        if (typeof initializeFavoriteButtons === 'function') {
            initializeFavoriteButtons();
        } else { console.error("H√†m initializeFavoriteButtons kh√¥ng t·ªìn t·∫°i."); }
    });
</script>
{% endblock %} {# K·∫øt th√∫c block scripts #}